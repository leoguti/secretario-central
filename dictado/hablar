#!/bin/bash
# hablar - Text-to-Speech en inglés usando OpenAI gpt-4o-mini-tts
# Usage:
#   hablar "Hello, how are you?"           # velocidad normal
#   hablar -s "This is a slow sentence"    # modo lento para aprendizaje
#   echo "text" | hablar                   # desde stdin
#   hablar -s                              # modo lento desde stdin

set -uo pipefail

SLOW_MODE=false
VOICE="nova"
AUDIOFILE="/tmp/hablar-audio.mp3"

# Parse flags
while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--slow)
            SLOW_MODE=true
            shift
            ;;
        -v|--voice)
            VOICE="$2"
            shift 2
            ;;
        *)
            break
            ;;
    esac
done

# Get text from argument or stdin
if [ $# -gt 0 ]; then
    TEXT="$*"
elif [ ! -t 0 ]; then
    TEXT=$(cat)
else
    echo "Uso: hablar [-s] \"texto en inglés\""
    echo "  -s    modo lento (para aprendizaje)"
    echo "  -v    voz (nova, alloy, echo, fable, onyx, shimmer)"
    exit 1
fi

if [ -z "$TEXT" ]; then
    echo "Error: no se proporcionó texto"
    exit 1
fi

# Load API key (same pattern as dictado)
if command -v op &>/dev/null; then
    OPENAI_API_KEY=$(op read "op://Private/OpenAI API Key/password" 2>/dev/null || true)
fi
if [ -z "${OPENAI_API_KEY:-}" ] && [ -f "$HOME/.config/dictado/.env" ]; then
    source "$HOME/.config/dictado/.env"
fi
if [ -z "${OPENAI_API_KEY:-}" ]; then
    echo "Error: no se encontró API key"
    exit 1
fi

# Build TTS instructions for speed control
if [ "$SLOW_MODE" = true ]; then
    INSTRUCTIONS="Speak slowly and clearly, as if teaching English to a student. Pause slightly between words and phrases."
else
    INSTRUCTIONS="Speak naturally at a normal conversational pace."
fi

# Call OpenAI TTS API
RESPONSE_CODE=$(curl -s -w "%{http_code}" -o "$AUDIOFILE" \
    --max-time 30 \
    https://api.openai.com/v1/audio/speech \
    -H "Authorization: Bearer $OPENAI_API_KEY" \
    -H "Content-Type: application/json" \
    -d "$(jq -n \
        --arg model "gpt-4o-mini-tts" \
        --arg input "$TEXT" \
        --arg voice "$VOICE" \
        --arg instructions "$INSTRUCTIONS" \
        '{
            model: $model,
            input: $input,
            voice: $voice,
            instructions: $instructions,
            response_format: "mp3"
        }')")

if [ "$RESPONSE_CODE" != "200" ]; then
    ERROR=$(cat "$AUDIOFILE" 2>/dev/null | jq -r '.error.message // "Error desconocido"' 2>/dev/null || echo "HTTP $RESPONSE_CODE")
    echo "Error TTS: $ERROR"
    rm -f "$AUDIOFILE"
    exit 1
fi

# Play audio (suppress ffplay output)
ffplay -nodisp -autoexit -loglevel quiet "$AUDIOFILE" 2>/dev/null
rm -f "$AUDIOFILE"
